# Story 6.8: Family Rule Configuration Interface

Status: ready-for-dev

## Story

As a **å®¶é•¿**,
I want **é…ç½®å®¶åº­å…¨å±€è§„åˆ™ï¼ˆç§¯åˆ†è§„åˆ™ã€Comboè§„åˆ™ã€æ„¿æœ›ç­–ç•¥ï¼‰**,
So that **æˆ‘å¯ä»¥ä¸ºæ•´ä¸ªå®¶åº­è®¾ç½®ä¸€è‡´çš„è¡Œä¸ºç®¡ç†æ ‡å‡†**ã€‚

## Acceptance Criteria

**Given** æˆ‘å·²ç™»å½•Family Rewardç³»ç»Ÿå¹¶æœ‰ä¸»è¦å®¶é•¿æƒé™
**When** æˆ‘è¿›å…¥"å®¶åº­è®¾ç½®"é¡µé¢ï¼ˆå·²ä»Epic 6è¿ç§»ï¼‰
**Then** ç³»ç»Ÿæ˜¾ç¤ºå®¶åº­è§„åˆ™é…ç½®ç•Œé¢ï¼ŒåŒ…å«ï¼š
  - é…ç½®åŒºåŸŸåˆ†ç»„ï¼š
     - ç§¯åˆ†è§„åˆ™é…ç½®
     - Comboè§„åˆ™é…ç½®
     - æ„¿æœ›ç­–ç•¥é…ç½®
     - ç³»ç»Ÿé€šçŸ¥åå¥½è®¾ç½®
  - ç§¯åˆ†è§„åˆ™é…ç½®é€‰é¡¹ï¼š
     - æ—¥ç§¯åˆ†ä¸Šé™ï¼ˆé»˜è®¤200åˆ†ï¼Œå¯è°ƒ500-2000åˆ†ï¼‰
     - è´Ÿåˆ†ä¸‹é™ï¼ˆé»˜è®¤-999åˆ†ï¼Œå¯è°ƒ-999åˆ°-50åˆ†ï¼‰
     - ç§¯åˆ†æœ‰æ•ˆæœŸï¼ˆé»˜è®¤æ°¸ä¹…ï¼Œå¯è®¾ç½®æœ‰æ•ˆæœŸï¼‰
     - å•ä¸ªä»»åŠ¡æœ€å¤§ç§¯åˆ†ï¼ˆé»˜è®¤100åˆ†ï¼Œå¯è°ƒ1-200åˆ†ï¼‰
     - æ˜¯å¦å…è®¸è´Ÿåˆ†ï¼ˆé»˜è®¤å…è®¸ï¼‰
     - ç§¯åˆ†è°ƒæ•´é¢‘ç‡é™åˆ¶ï¼ˆé»˜è®¤æ— é™åˆ¶ï¼‰
  - Comboè§„åˆ™é…ç½®é€‰é¡¹ï¼š
     - çº¿æ€§Comboå¼€å…³ï¼ˆå¼€/å…³ï¼‰
     - çº¿æ€§Comboå¥–åŠ±ç§¯åˆ†ï¼ˆå¯é…ç½®ï¼‰
     - é˜¶æ¢¯Comboå¥–åŠ±è§„åˆ™ï¼ˆå¯é…ç½®å¤šæ®µé˜ˆå€¼ï¼‰
     - Comboä¸­æ–­é¢„è­¦å¼€å…³ï¼ˆå¼€/å…³ï¼‰
     - Comboå®½é™æ¬¡æ•°ï¼ˆé»˜è®¤1æ¬¡ï¼Œå¯è°ƒ1-3æ¬¡ï¼‰
  - æ„¿æœ›ç­–ç•¥é…ç½®é€‰é¡¹ï¼š
     - å•ä¸ªå„¿ç«¥æœ€å¤§æ„¿æœ›æ•°ï¼ˆé»˜è®¤5ä¸ªï¼Œå¯è°ƒ1-20ä¸ªï¼‰
     - å•ä¸ªæ„¿æœ›ç§¯åˆ†é—¨æ§›ä¸‹é™ï¼ˆé»˜è®¤50åˆ†ï¼Œå¯è°ƒ10-500åˆ†ï¼‰
     - å®¶é•¿å®¡æ ¸å¿…å¡«å¼€å…³ï¼ˆå¼€/å…³ï¼Œé»˜è®¤å¼€ï¼‰
     - æ„¿æœ›æœ‰æ•ˆæœŸï¼ˆé»˜è®¤æ°¸ä¹…ï¼Œå¯è®¾ç½®æœ‰æ•ˆæœŸï¼‰
  - ç³»ç»Ÿé€šçŸ¥åå¥½è®¾ç½®ï¼š
     - ä»»åŠ¡æé†’å¼€å…³
     - ç§¯åˆ†å˜åŠ¨é€šçŸ¥å¼€å…³
     - æ„¿æœ›å®¡æ ¸é€šçŸ¥å¼€å…³
     - Comboé¢„è­¦é€šçŸ¥å¼€å…³
     - ç³»ç»Ÿå…¬å‘Šé€šçŸ¥å¼€å…³
     - é€šçŸ¥æ¨é€æ—¶æ®µï¼ˆå¦‚8:00-22:00ï¼Œé˜²æ­¢æ·±å¤œæ‰“æ‰°ï¼‰
  - "ä¿å­˜è§„åˆ™"æŒ‰é’®ï¼šä¿å­˜æ‰€æœ‰é…ç½®é¡¹
  - "é‡ç½®ä¸ºé»˜è®¤"æŒ‰é’®ï¼šæ¢å¤æ‰€æœ‰é…ç½®é¡¹åˆ°ç³»ç»Ÿé»˜è®¤å€¼
**And** å½“æˆ‘ä¿®æ”¹é…ç½®é¡¹æ—¶ï¼Œæ˜¾ç¤ºå³æ—¶é¢„è§ˆï¼ˆæˆ–ç¡®è®¤å¯¹è¯æ¡†ï¼Œå¯¹äºé‡è¦è§„åˆ™ï¼‰
**Then** ç‚¹å‡»"ä¿å­˜è§„åˆ™"æŒ‰é’®åï¼Œæ‰€æœ‰é…ç½®é¡¹ä¿å­˜åˆ°`family_settings`è¡¨
**Then** é…ç½®ç”Ÿæ•ˆæ—¶é—´ï¼šç«‹å³ç”Ÿæ•ˆï¼ˆéƒ¨åˆ†è§„åˆ™å¦‚æ–°ä»»åŠ¡ï¼‰æˆ–æ¬¡æ—¥ç”Ÿæ•ˆï¼ˆå¦‚ç§¯åˆ†ä¸Šé™ï¼‰
**Then** ä¿å­˜æˆåŠŸåï¼Œæ˜¾ç¤ºæˆåŠŸæç¤ºï¼š"å®¶åº­è§„åˆ™å·²ä¿å­˜"
**And** å¦‚æœä¿®æ”¹äº†é‡è¦è§„åˆ™ï¼ˆå¦‚å…³é—­è´Ÿåˆ†ï¼‰ï¼Œæ˜¾ç¤ºäºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†ï¼š"ç¡®è®¤è¦å…³é—­è´Ÿåˆ†åŠŸèƒ½å—ï¼Ÿå…³é—­åå„¿ç«¥æ— æ³•è·å¾—è´Ÿåˆ†"
**And** å¦‚æœå®¶åº­æœ‰å¤šä¸ªå„¿ç«¥ï¼Œé…ç½®é¡¹å¯é’ˆå¯¹ç‰¹å®šå„¿ç«¥è®¾ç½®ï¼ˆæ¬¡è¦å®¶é•¿å¯èƒ½åªè¯»ï¼‰
**And** æ‰€æœ‰å®¶é•¿æŸ¥çœ‹ç›¸åŒçš„å®¶åº­è§„åˆ™ï¼ˆä¸»è¦å®¶é•¿è®¾ç½®å…¨å±€ï¼Œæ¬¡è¦å®¶é•¿åªè¯»ï¼‰
**And** æ“ä½œè®°å½•åˆ°å®¡è®¡æ—¥å¿—ï¼ˆNFR14ï¼‰
**And** APIå“åº”æ—¶é—´<500msï¼ˆNFR3: P95ï¼‰
**And** å‚è€ƒArchitecture: å®¶åº­è§„åˆ™å­˜å‚¨åœ¨`family_settings`è¡¨ä¸­ï¼ŒEpic 6ä¿ç•™é…ç½®åŠŸèƒ½
**And** å‚è€ƒFR60: å®¶é•¿å¯ä»¥é…ç½®å®¶åº­å…¨å±€è§„åˆ™

## Tasks / Subtasks

- [ ] Task 1: Create database schema for family_settings (AC: Then)
  - [ ] Subtask 1.1: Design family_settings table schema in database/schema/
  - [ ] Subtask 1.2: Create Drizzle migration file in database/migrations/
  - [ ] Subtask 1.3: Run migration to create family_settings table
  - [ ] Subtask 1.4: Add audit log entry (NFR14)

- [ ] Task 2: Create database query functions for family settings (AC: Then)
  - [ ] Subtask 2.1: Create lib/db/queries/family-settings.ts
  - [ ] Subtask 2.2: Implement getFamilySettings() function
  - [ ] Subtask 2.3: Implement updateFamilySettings() function
  - [ ] Subtask 2.4: Implement resetToDefaults() function
  - [ ] Subtask 2.5: Implement getDefaultSettings() function (system defaults)

- [ ] Task 3: Create API endpoints for family settings (AC: When/Then)
  - [ ] Subtask 3.1: Create GET /api/family/settings endpoint (get settings)
  - [ ] Subtask 3.2: Create PUT /api/family/settings endpoint (update settings)
  - [ ] Subtask 3.3: Create PUT /api/family/settings/reset endpoint (reset to defaults)
  - [ ] Subtask 3.4: Add parent authentication middleware (primary parent only for updates)
  - [ ] Subtask 3.5: Validate request data (Zod schemas)
  - [ ] Subtask 3.6: Add secondary parent read-only permission check

- [ ] Task 4: Create family settings page (AC: When)
  - [ ] Subtask 4.1: Create app/(parent)/settings/page.tsx (main page)
  - [ ] Subtask 4.2: Create components/forms/family-settings-form.tsx (main form)
  - [ ] Subtask 4.3: Create components/forms/points-rules-section.tsx (points configuration)
  - [ ] Subtask 4.4: Create components/forms/combo-rules-section.tsx (combo configuration)
  - [ ] Subtask 4.5: Create components/forms/wish-policy-section.tsx (wish policy)

- [ ] Task 5: Implement points rules configuration UI (AC: Then)
  - [ ] Subtask 5.1: Add daily pointsä¸Šé™ input (default 200, range 500-2000)
  - [ ] Subtask 5.2: Add è´Ÿåˆ†ä¸‹é™ input (default -999, range -999 to -50)
  - [ ] Subtask 5.3: Add pointsæœ‰æ•ˆæœŸ selector (default permanent, optional expiry date)
  - [ ] Subtask 5.4: Add single task max points input (default 100, range 1-200)
  - [ ] Subtask 5.5: Add allow negative points toggle (default true)
  - [ ] Subtask 5.6: Add points adjustment frequency limit input

- [ ] Task 6: Implement combo rules configuration UI (AC: Then)
  - [ ] Subtask 6.1: Add linear combo toggle switch
  - [ ] Subtask 6.2: Add linear combo reward points input
  - [ ] Subtask 6.3: Add tiered combo rules editor (thresholds + rewards)
  - [ ] Subtask 6.4: Add combo interruption warning toggle switch
  - [ ] Subtask 6.5: Add comboå®½é™æ¬¡æ•° selector (default 1, range 1-3)

- [ ] Task 7: Implement wish policy configuration UI (AC: Then)
  - [ ] Subtask 7.1: Add max wishes per child input (default 5, range 1-20)
  - [ ] Subtask 7.2: Add min wish points threshold input (default 50, range 10-500)
  - [ ] Subtask 7.3: Add parent approval required toggle (default true)
  - [ ] Subtask 7.4: Add wish validity selector (default permanent, optional expiry date)

- [ ] Task 8: Implement notification preferences UI (AC: Then)
  - [ ] Subtask 8.1: Add task reminder notification toggle
  - [ ] Subtask 8.2: Add points change notification toggle
  - [ ] Subtask 8.3: Add wish review notification toggle
  - [ ] Subtask 8.4: Add combo warning notification toggle
  - [ ] Subtask 8.5: Add system announcement notification toggle
  - [ ] Subtask 8.6: Add notification time range picker (default 8:00-22:00)

- [ ] Task 9: Implement save and reset functionality (AC: Then)
  - [ ] Subtask 9.1: Add "ä¿å­˜è§„åˆ™" button (save all settings)
  - [ ] Subtask 9.2: Add "é‡ç½®ä¸ºé»˜è®¤" button (reset to defaults)
  - [ ] Subtask 9.3: Implement immediate effect for most settings
  - [ ] Subtask 9.4: Implement next-day effect for some settings (points limits)
  - [ ] Subtask 9.5: Add confirmation dialogs for critical changes (e.g., disable negative points)

- [ ] Task 10: Add permission handling for multiple children (AC: Then)
  - [ ] Subtask 10.1: Detect if family has multiple children
  - [ ] Subtask 10.2: Add child selector for per-child settings
  - [ ] Subtask 10.3: Implement secondary parent read-only mode
  - [ ] Subtask 10.4: Disable settings inputs for secondary parents
  - [ ] Subtask 10.5: Add "ä¸»è¦å®¶é•¿è®¾ç½®å…¨å±€ï¼Œæ¬¡è¦å®¶é•¿åªè¯»" note

- [ ] Task 11: Add validation and error handling (AC: NFR14, NFR3)
  - [ ] Subtask 11.1: Validate settings values (ranges, constraints)
  - [ ] Subtask 11.2: Add error messages for validation failures
  - [ ] Subtask 11.3: Add Shadcn Toast notifications for success/error
  - [ ] Subtask 11.4: Log audit trail for all settings changes

- [ ] Task 12: Write BDD tests (AC: NFR14, NFR3)
  - [ ] Subtask 12.1: Write integration tests for API endpoints
  - [ ] Subtask 12.2: Write unit tests for query functions
  - [ ] Subtask 12.3: Write E2E tests with Playwright (save settings, reset settings)
  - [ ] Subtask 12.4: Verify API response time < 500ms
  - [ ] Subtask 12.5: Verify permission checks (primary vs secondary parent)

## Dev Notes

### Technical Stack & Requirements

**Core Technologies:**
- Bun 1.3.x+ (runtime)
- Next.js 16.1.6 + React 19.2.3
- Drizzle ORM 0.45.1+ (database queries)
- TypeScript 5 strict mode
- Shadcn UI 3.7.0+ (UI components)
- Tailwind CSS 4 (styling)

### Database Schema

**New family_settings table:**
```typescript
// database/schema/family-settings.ts
import { sqliteTable, text, integer, timestamp, boolean } from 'drizzle-orm/sqlite-core';
import { sql } from 'drizzle-orm';

export const familySettings = sqliteTable('family_settings', {
  id: text('id').primaryKey(),
  familyId: text('family_id').notNull(),
  childId: text('child_id'), // NULL for global settings, child ID for per-child settings
  settingCategory: text('setting_category', { enum: ['points', 'combo', 'wish', 'notifications'] }).notNull(),
  settingKey: text('setting_key').notNull(), // e.g., "daily_points_max", "negative_points_min"
  settingValue: text('setting_value').notNull(), // JSON string for complex values
  isGlobal: integer('is_global', { mode: 'boolean' }).default(true).notNull(), // true = global, false = per-child
  updatedBy: text('updated_by').notNull(), // parent user ID
  updatedAt: timestamp('updated_at').default(sql`CURRENT_TIMESTAMP`).notNull(),
  createdAt: timestamp('created_at').default(sql`CURRENT_TIMESTAMP`).notNull(),
}, (table) => ({
  familyIdx: index('family_idx').on(table.familyId),
  childIdx: index('child_idx').on(table.childId),
  categoryKeyIdx: index('category_key_idx').on(table.settingCategory, table.settingKey),
}));

export type FamilySetting = typeof familySettings.$inferSelect;
export type NewFamilySetting = typeof familySettings.$inferInsert;
```

**Default Settings Values:**
```typescript
const DEFAULT_SETTINGS = {
  // Points Rules
  dailyPointsMax: 200,
  negativePointsMin: -999,
  pointsExpiry: null, // NULL = permanent
  taskMaxPoints: 100,
  allowNegativePoints: true,
  pointsAdjustFrequencyLimit: null, // NULL = no limit

  // Combo Rules
  linearComboEnabled: true,
  linearComboRewardPoints: 30, // per 7 days
  tieredComboRules: [
    { days: 7, reward: 30 },
    { days: 14, reward: 70 },
    { days: 30, reward: 150 }
  ],
  comboInterruptionWarningEnabled: true,
  comboGracePeriod: 1,

  // Wish Policy
  maxWishesPerChild: 5,
  minWishPointsThreshold: 50,
  parentApprovalRequired: true,
  wishExpiry: null, // NULL = permanent

  // Notification Preferences
  taskReminderEnabled: true,
  pointsChangeEnabled: true,
  wishReviewEnabled: true,
  comboWarningEnabled: true,
  systemAnnouncementEnabled: true,
  notificationTimeRange: '08:00-22:00',
};
```

### API Endpoints

| Method | Path | Purpose | Auth |
|--------|------|---------|------|
| GET | `/api/family/settings` | Get family settings | Parent |
| PUT | `/api/family/settings` | Update settings | Primary Parent |
| PUT | `/api/family/settings/reset` | Reset to defaults | Primary Parent |

**Request/Response DTOs:**

```typescript
// Get Settings Response
{
  familyId: string;
  settings: {
    pointsRules: PointsRules;
    comboRules: ComboRules;
    wishPolicy: WishPolicy;
    notificationPreferences: NotificationPreferences;
  };
  hasMultipleChildren: boolean;
  isPrimaryParent: boolean;
}

// Update Settings Request
{
  pointsRules?: Partial<PointsRules>;
  comboRules?: Partial<ComboRules>;
  wishPolicy?: Partial<WishPolicy>;
  notificationPreferences?: Partial<NotificationPreferences>;
}

// Settings Objects
interface PointsRules {
  dailyPointsMax: number;      // 500-2000
  negativePointsMin: number;      // -999 to -50
  pointsExpiry: string | null;   // ISO date or NULL
  taskMaxPoints: number;        // 1-200
  allowNegativePoints: boolean;   // true/false
  pointsAdjustFrequencyLimit: number | null; // NULL = no limit
}

interface ComboRules {
  linearComboEnabled: boolean;
  linearComboRewardPoints: number;
  tieredComboRules: Array<{
    days: number;
    reward: number;
  }>;
  comboInterruptionWarningEnabled: boolean;
  comboGracePeriod: number; // 1-3
}

interface WishPolicy {
  maxWishesPerChild: number;     // 1-20
  minWishPointsThreshold: number;  // 10-500
  parentApprovalRequired: boolean; // true/false
  wishExpiry: string | null;      // ISO date or NULL
}

interface NotificationPreferences {
  taskReminderEnabled: boolean;
  pointsChangeEnabled: boolean;
  wishReviewEnabled: boolean;
  comboWarningEnabled: boolean;
  systemAnnouncementEnabled: boolean;
  notificationTimeRange: string; // "HH:MM-HH:MM"
}
```

### Project Structure Notes

**Files to Create/Modify:**

```
database/schema/
â”œâ”€â”€ family-settings.ts      # NEW: Table schema

database/migrations/
â”œâ”€â”€ xxx_create_family_settings.sql  # NEW: Migration

lib/db/queries/
â”œâ”€â”€ family-settings.ts       # NEW: Query functions

app/(parent)/
â”œâ”€â”€ settings/
â”‚   â””â”€â”€ page.tsx           # NEW: Family settings page

components/forms/
â”œâ”€â”€ family-settings-form.tsx  # NEW: Main form with sections
â”œâ”€â”€ points-rules-section.tsx   # NEW: Points configuration
â”œâ”€â”€ combo-rules-section.tsx   # NEW: Combo configuration
â”œâ”€â”€ wish-policy-section.tsx   # NEW: Wish policy

tests/integration/
â”œâ”€â”€ family-settings.spec.ts  # NEW: API tests

tests/e2e/
â”œâ”€â”€ family-settings.spec.ts  # NEW: E2E tests
```

**Alignment with Unified Project Structure:**

- âœ… Schema in `database/schema/family-settings.ts` (per architecture)
- âœ… Queries in `lib/db/queries/family-settings.ts` (per-table file pattern)
- âœ… API routes in `app/api/family/settings/` (RESTful pattern)
- âœ… Components in `components/forms/` (form-based)
- âœ… No conflicts detected

### References

- **Architecture Decision:** ADR-5 (Function-based queries, NOT Repository pattern)
- **API Pattern:** [Source: docs/TECH_SPEC_API.md#REST-endpoints]
- **Component System:** [Source: docs/TECH_SPEC_ARCHITECTURE.md#component-boundaries]
- **Testing Standard:** [Source: docs/TECH_SPEC_BDD.md#Given-When-Then]
- **FR60:** [Source: _bmad-output/planning-artifacts/prd.md#FR60] å®¶é•¿å¯ä»¥é…ç½®å®¶åº­å…¨å±€è§„åˆ™
- **Permission Model:** [Source: _bmad-output/planning-artifacts/ux-design-specification.md#decision-5-secondary-vs-primary-parent-permissions]

### Critical Implementation Constraints

**ğŸ”´ RED LIST - MUST OBEY:**

1. **Database Operations:**
   - âœ… MUST use Drizzle ORM query builder
   - âŒ NEVER use raw SQL
   - âŒ NEVER write SQL in components/routes
   - âœ… All queries MUST be in `lib/db/queries/family-settings.ts`

2. **Type Safety:**
   - âŒ NEVER use `any` type
   - âœ… MUST use `unknown` + type guards
   - âœ… NO `@ts-ignore` or `@ts-expect-error`

3. **Bun Runtime:**
   - âœ… MUST use `Bun.file()`, `Bun.write()` for file ops
   - âœ… MUST use `Bun.env` for environment variables
   - âŒ NEVER use Node.js APIs (`fs/promises`, `process.env`)

4. **BDD Testing:**
   - âœ… MUST write tests BEFORE implementation
   - âœ… MUST use Given-When-Then format
   - âœ… MUST use business language, NOT technical terms

5. **File Length:**
   - âœ… All files MUST be â‰¤ 800 lines
   - âœ… Split large components if needed

### UX/UI Requirements

**From UX Design Specification:**

- **Responsive Design:**
  - Parent mini-program layout: <450px width (portrait optimization)
  - Large buttons for easy clicking
  - Clear visual hierarchy

- **Form Design:**
  - Section-based layout (Points Rules / Combo Rules / Wish Policy / Notifications)
  - Accordion or tabs for sections
  - Clear labeling and groupings
  - Range sliders for numeric inputs where appropriate

- **Permission Handling:**
  - Primary parent: All settings editable
  - Secondary parent: All settings read-only
  - Note: "ä¸»è¦å®¶é•¿è®¾ç½®å…¨å±€ï¼Œæ¬¡è¦å®¶é•¿åªè¯»"

- **Confirmation Dialogs:**
  - Show confirmation for critical changes (disable negative points)
  - Confirm before reset to defaults
  - Preview effect before applying changes

- **Feedback:**
  - Success toast: "å®¶åº­è§„åˆ™å·²ä¿å­˜"
  - Success toast: "å·²é‡ç½®ä¸ºé»˜è®¤å€¼"
  - Error toast with clear message
  - Loading states during save

### Testing Standards Summary

**BDD Format (Given-When-Then):**

```typescript
// Example: Get family settings
it('given ä¸»è¦å®¶é•¿å·²ç™»å½•ï¼Œwhen æŸ¥è¯¢å®¶åº­è®¾ç½®ï¼Œthen è¿”å›æ‰€æœ‰é…ç½®é¡¹', async () => {
  // Given: ä¸»è¦å®¶é•¿å·²ç™»å½•
  const primaryParent = await createParent({ role: 'primary' });

  // When: æŸ¥è¯¢å®¶åº­è®¾ç½®
  const res = await request(app)
    .get('/api/family/settings')
    .set('Cookie', primaryParent.session);

  // Then: è¿”å›æ‰€æœ‰é…ç½®é¡¹
  expect(res.status).toBe(200);
  expect(res.body.settings).toHaveProperty('pointsRules');
  expect(res.body.settings).toHaveProperty('comboRules');
  expect(res.body.settings).toHaveProperty('wishPolicy');
  expect(res.body.settings).toHaveProperty('notificationPreferences');
  expect(res.body.isPrimaryParent).toBe(true);
});

// Example: Update settings
it('given ä¸»è¦å®¶é•¿å·²ç™»å½•ï¼Œwhen æ›´æ–°ç§¯åˆ†è§„åˆ™ï¼Œthen è®¾ç½®ä¿å­˜å¹¶ç«‹å³ç”Ÿæ•ˆ', async () => {
  // Given: ä¸»è¦å®¶é•¿å·²ç™»å½•
  const primaryParent = await createParent({ role: 'primary' });

  // When: æ›´æ–°ç§¯åˆ†è§„åˆ™
  const res = await request(app)
    .put('/api/family/settings')
    .set('Cookie', primaryParent.session)
    .send({
      pointsRules: {
        dailyPointsMax: 500,
        taskMaxPoints: 150
      }
    });

  // Then: è®¾ç½®ä¿å­˜å¹¶ç«‹å³ç”Ÿæ•ˆ
  expect(res.status).toBe(200);
  expect(res.body.settings.pointsRules.dailyPointsMax).toBe(500);
  expect(res.body.settings.pointsRules.taskMaxPoints).toBe(150);
  // Verify saved in database
  const settings = await getFamilySettings(primaryParent.familyId);
  expect(settings.dailyPointsMax).toBe(500);
});

// Example: Secondary parent read-only
it('given æ¬¡è¦å®¶é•¿å·²ç™»å½•ï¼Œwhen å°è¯•æ›´æ–°è®¾ç½®ï¼Œthen è¿”å›æƒé™é”™è¯¯', async () => {
  // Given: æ¬¡è¦å®¶é•¿å·²ç™»å½•
  const secondaryParent = await createParent({ role: 'secondary' });

  // When: å°è¯•æ›´æ–°è®¾ç½®
  const res = await request(app)
    .put('/api/family/settings')
    .set('Cookie', secondaryParent.session)
    .send({
      pointsRules: { dailyPointsMax: 500 }
    });

  // Then: è¿”å›æƒé™é”™è¯¯
  expect(res.status).toBe(403);
  expect(res.body.error).toContain('åªæœ‰ä¸»è¦å®¶é•¿å¯ä»¥ä¿®æ”¹å®¶åº­è§„åˆ™');
});

// Example: Reset to defaults
it('given ä¸»è¦å®¶é•¿å·²ç™»å½•ï¼Œwhen é‡ç½®ä¸ºé»˜è®¤å€¼ï¼Œthen æ‰€æœ‰è®¾ç½®æ¢å¤ä¸ºç³»ç»Ÿé»˜è®¤', async () => {
  // Given: ä¸»è¦å®¶é•¿å·²ç™»å½•
  const primaryParent = await createParent({ role: 'primary' });

  // When: é‡ç½®ä¸ºé»˜è®¤å€¼
  const res = await request(app)
    .put('/api/family/settings/reset')
    .set('Cookie', primaryParent.session);

  // Then: æ‰€æœ‰è®¾ç½®æ¢å¤ä¸ºç³»ç»Ÿé»˜è®¤
  expect(res.status).toBe(200);
  expect(res.body.settings.pointsRules.dailyPointsMax).toBe(200);
  expect(res.body.settings.comboRules.linearComboRewardPoints).toBe(30);
});
```

**Test Coverage Requirements:**
- API endpoints: 100% coverage
- Query functions: 95%+ coverage
- E2E tests: Main workflows (view settings, update settings, reset settings)
- Permission tests: Primary vs Secondary parent
- Performance tests: Verify API response time < 500ms

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
