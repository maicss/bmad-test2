# Story 6.6: Admin Sends System Announcement

Status: ready-for-dev

## Story

As a **ç®¡ç†å‘˜**,
I want **å‘æ‰€æœ‰å®¶é•¿å‘é€ç³»ç»Ÿå…¬å‘Šæˆ–é‡è¦é€šçŸ¥**,
So that **å®¶é•¿å¯ä»¥äº†è§£ç³»ç»Ÿæ›´æ–°ã€æ–°åŠŸèƒ½å‘å¸ƒã€é‡è¦äº‹ä»¶**ã€‚

## Acceptance Criteria

**Given** æˆ‘å·²ç™»å½•Family Rewardç³»ç»Ÿå¹¶æœ‰ç®¡ç†å‘˜æƒé™
**When** æˆ‘è¿›å…¥ç®¡ç†å‘˜"ç³»ç»Ÿé€šçŸ¥"é¡µé¢å¹¶ç‚¹å‡»"å‘é€é€šçŸ¥"æŒ‰é’®
**Then** ç³»ç»Ÿæ˜¾ç¤ºé€šçŸ¥å‘é€è¡¨å•ï¼ŒåŒ…å«ï¼š
  - é€šçŸ¥ç±»å‹é€‰æ‹©å™¨ï¼š
     - ç³»ç»Ÿå…¬å‘Šï¼ˆé»˜è®¤ï¼‰
     - æ–°åŠŸèƒ½å‘å¸ƒ
     - é‡è¦æé†’
     - æ´»åŠ¨é€šçŸ¥
  - æ ‡é¢˜è¾“å…¥æ¡†ï¼ˆå¿…å¡«ï¼Œæœ€å¤š100å­—ï¼‰
  - å†…å®¹è¾“å…¥æ¡†ï¼ˆå¿…å¡«ï¼Œæœ€å¤š500å­—ï¼Œæ”¯æŒMarkdownæ ¼å¼ï¼‰
  - ç›®æ ‡ç¾¤ä½“é€‰æ‹©å™¨ï¼š
     - æ‰€æœ‰å®¶é•¿
     - ç‰¹å®šå¹´é¾„æ®µï¼ˆå¯é€‰ï¼‰
     - ç‰¹å®šå®¶åº­IDï¼ˆå¯é€‰ï¼‰
  - å‘é€æ–¹å¼ï¼š
     - ç«‹å³å‘é€ï¼šæ¨é€åˆ°æ‰€æœ‰åœ¨çº¿å®¶é•¿è®¾å¤‡
     - å®šæ—¶å‘é€ï¼šé€‰æ‹©å…·ä½“æ—¶é—´å‘é€
  - å‘å¸ƒå¼€å…³ï¼š
     - è‰ç¨¿ï¼šä¿å­˜åä¸ç«‹å³å‘é€
     - å‘å¸ƒï¼šç«‹å³æ¨é€é€šçŸ¥
**And** å½“æˆ‘è¾“å…¥å®Œæ ‡é¢˜å’Œå†…å®¹åï¼Œå¯ä»¥ç‚¹å‡»"é¢„è§ˆ"æŒ‰é’®æŸ¥çœ‹æœ€ç»ˆæ•ˆæœ
**Then** é¢„è§ˆæ˜¾ç¤ºåœ¨å¯¹è¯æ¡†ä¸­ï¼Œæ”¯æŒMarkdownæ¸²æŸ“ï¼ˆæ ‡é¢˜åŠ ç²—ã€åˆ—è¡¨æ ¼å¼ã€é“¾æ¥ï¼‰
**And** å¦‚æœé€‰æ‹©"ç«‹å³å‘é€"ï¼ŒéªŒè¯å†…å®¹æ˜¯å¦ä¸ºç©º
**And** ç‚¹å‡»"å‘é€"æŒ‰é’®åï¼Œé€šçŸ¥æ¨é€åˆ°æ‰€æœ‰å®¶é•¿è®¾å¤‡ï¼ˆPWAå’Œå°ç¨‹åºï¼‰
**Then** é€šçŸ¥å†…å®¹æ˜¾ç¤ºåœ¨å®¶é•¿"é€šçŸ¥ä¸­å¿ƒ"é¡µé¢ï¼ˆå·²ä»Epic 6è¿ç§»ï¼‰
**Then** é€šçŸ¥åœ¨PWAä¸­æ˜¾ç¤ºä¸ºå¼¹çª—æˆ–æ¨ªå¹…ï¼Œåœ¨å°ç¨‹åºä¸­æ˜¾ç¤ºä¸ºæ¶ˆæ¯æ¡
**Then** é€šçŸ¥åŒ…å«ï¼š
  - ç®¡ç†å‘˜å¤´åƒå’Œå§“å
  - å‘é€æ—¶é—´
  - é€šçŸ¥ç±»å‹æ ‡ç­¾ï¼ˆä¸åŒé¢œè‰²ï¼‰
  - æ ‡é¢˜å’Œå†…å®¹
  - é˜…è¯»çŠ¶æ€ï¼ˆæœªè¯»/å·²è¯»ï¼‰
**And** å‘é€æˆåŠŸåï¼Œæ˜¾ç¤ºæˆåŠŸæç¤ºï¼š"é€šçŸ¥å·²å‘é€åˆ°Xä¸ªå®¶é•¿"
**And** é€šçŸ¥è®°å½•å­˜å‚¨åœ¨`notifications`è¡¨ä¸­ï¼Œå…³è”åˆ°æ‰€æœ‰å®¶é•¿è´¦æˆ·
**And** å®¶é•¿å¯ä»¥æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
**And** æ“ä½œè®°å½•åˆ°å®¡è®¡æ—¥å¿—ï¼ˆNFR14ï¼‰
**And** é€šçŸ¥ç±»å‹æ ‡è®°ä¸º"ç³»ç»Ÿå…¬å‘Š"ï¼ˆä¾¿äºå®¶é•¿ç­›é€‰ï¼‰
**And** APIå“åº”æ—¶é—´<500msï¼ˆNFR3: P95ï¼‰
**And** å‚è€ƒArchitecture: ä½¿ç”¨`lib/notifications/push.ts`æœåŠ¡å‘é€é€šçŸ¥
**And** å‚è€ƒFR54: ç®¡ç†å‘˜å¯ä»¥å‘å®¶é•¿å‘é€ç³»ç»Ÿé€šçŸ¥

## Tasks / Subtasks

- [ ] Task 1: Verify/extend database schema for notifications (AC: Then)
  - [ ] Subtask 1.1: Review notifications table schema in database/schema/
  - [ ] Subtask 1.2: Add admin-specific fields if needed (admin_id, system_announcement flag)
  - [ ] Subtask 1.3: Create migration if schema changes needed
  - [ ] Subtask 1.4: Add audit log entry (NFR14)

- [ ] Task 2: Create database query functions for notifications (AC: Then)
  - [ ] Subtask 2.1: Create lib/db/queries/notifications.ts
  - [ ] Subtask 2.2: Implement createSystemAnnouncement() function
  - [ ] Subtask 2.3: Implement bulkCreateNotifications() function (for all parents)
  - [ ] Subtask 2.4: Implement markNotificationAsRead() function
  - [ ] Subtask 2.5: Implement getNotificationStats() function

- [ ] Task 3: Create API endpoints for system announcements (AC: When/Then)
  - [ ] Subtask 3.1: Create POST /api/admin/announcements endpoint (create announcement)
  - [ ] Subtask 3.2: Create GET /api/admin/announcements/[id] endpoint (preview announcement)
  - [ ] Subtask 3.3: Create GET /api/admin/announcements endpoint (list announcements)
  - [ ] Subtask 3.4: Add admin authentication middleware
  - [ ] Subtask 3.5: Validate request data (Zod schemas)
  - [ ] Subtask 3.6: Implement scheduled sending (background job placeholder)

- [ ] Task 4: Create admin announcement page (AC: When)
  - [ ] Subtask 4.1: Create app/admin/announcements/page.tsx (list view)
  - [ ] Subtask 4.2: Create app/admin/announcements/create/page.tsx (create form)
  - [ ] Subtask 4.3: Create components/forms/announcement-form.tsx
  - [ ] Subtask 4.4: Create components/features/announcement-preview.tsx (markdown preview)
  - [ ] Subtask 4.5: Create components/features/markdown-editor.tsx (rich text placeholder)

- [ ] Task 5: Implement announcement creation form UI (AC: When/Then)
  - [ ] Subtask 5.1: Add notification type selector (system/update/reminder/activity)
  - [ ] Subtask 5.2: Add title input (required, max 100 chars)
  - [ ] Subtask 5.3: Add content input (required, max 500 chars, markdown support)
  - [ ] Subtask 5.4: Add target group selector (all parents / age group / specific families)
  - [ ] Subtask 5.5: Add send method selector (immediate / scheduled)
  - [ ] Subtask 5.6: Add "Save as Draft" / "Publish" toggle
  - [ ] Subtask 5.7: Add "Preview" button for markdown rendering

- [ ] Task 6: Implement announcement sending workflow (AC: Then)
  - [ ] Subtask 6.1: Add draft save functionality (stores announcement, does not send)
  - [ ] Subtask 6.2: Add publish confirmation dialog
  - [ ] Subtask 6.3: Implement immediate sending (push to all parent devices)
  - [ ] Subtask 6.4: Implement scheduled sending (background job placeholder)
  - [ ] Subtask 6.5: Create notifications for all parents in database
  - [ ] Subtask 6.6: Display success message: "é€šçŸ¥å·²å‘é€åˆ°Xä¸ªå®¶é•¿"

- [ ] Task 7: Create notification preview modal (AC: Then)
  - [ ] Subtask 7.1: Create preview dialog modal (Shadcn Dialog)
  - [ ] Subtask 7.2: Render markdown content (title, lists, links)
  - [ ] Subtask 7.3: Display admin avatar and name
  - [ ] Subtask 7.4: Display notification type badge (colored)
  - [ ] Subtask 7.5: Show timestamp

- [ ] Task 8: Add validation and error handling (AC: NFR14, NFR3)
  - [ ] Subtask 8.1: Validate required fields (Zod schemas)
  - [ ] Subtask 8.2: Add error messages for validation failures
  - [ ] Subtask 8.3: Add Shadcn Toast notifications for success/error
  - [ ] Subtask 8.4: Log audit trail for all operations

- [ ] Task 9: Write BDD tests (AC: NFR14, NFR3)
  - [ ] Subtask 9.1: Write integration tests for API endpoints
  - [ ] Subtask 9.2: Write unit tests for query functions
  - [ ] Subtask 9.3: Write E2E tests with Playwright (create draft â†’ preview â†’ publish)
  - [ ] Subtask 9.4: Verify API response time < 500ms
  - [ ] Subtask 9.5: Verify notification creation for all parents

## Dev Notes

### Technical Stack & Requirements

**Core Technologies:**
- Bun 1.3.x+ (runtime)
- Next.js 16.1.6 + React 19.2.3
- Drizzle ORM 0.45.1+ (database queries)
- TypeScript 5 strict mode
- Shadcn UI 3.7.0+ (UI components)
- Tailwind CSS 4 (styling)

**Markdown Support:**
- Simple markdown rendering for announcement content
- Bold, lists, links support
- Use Shadcn UI components for preview

### Database Schema Extensions

**Notifications table (extended if needed):**
```typescript
// database/schema/notifications.ts - REVIEW existing schema
import { sqliteTable, text, integer, timestamp, boolean } from 'drizzle-orm/sqlite-core';
import { sql } from 'drizzle-orm';

export const notifications = sqliteTable('notifications', {
  id: text('id').primaryKey(),
  userId: text('user_id').notNull(), // Recipient parent ID
  type: text('type', { enum: ['system', 'task', 'points', 'wish', 'combo'] }).notNull(),
  subtype: text('subtype'), // system, update, reminder, activity
  title: text('title').notNull(),
  content: text('content').notNull(), // Markdown format
  isRead: integer('is_read', { mode: 'boolean' }).default(false).notNull(),
  sentBy: text('sent_by'), // Admin user ID for system announcements
  scheduledFor: timestamp('scheduled_for'), // NULL for immediate, timestamp for scheduled
  sentAt: timestamp('sent_at'), // Actual send time
  createdAt: timestamp('created_at').default(sql`CURRENT_TIMESTAMP`).notNull(),
});

export type Notification = typeof notifications.$inferSelect;
export type NewNotification = typeof notifications.$inferInsert;
```

### API Endpoints

| Method | Path | Purpose | Auth |
|--------|------|---------|------|
| POST | `/api/admin/announcements` | Create announcement (draft/publish) | Admin |
| GET | `/api/admin/announcements/[id]` | Preview announcement | Admin |
| GET | `/api/admin/announcements` | List announcements (with filters) | Admin |
| DELETE | `/api/admin/announcements/[id]` | Delete announcement | Admin |
| PUT | `/api/admin/notifications/[id]/read` | Mark notification as read | Parent |

**Request/Response DTOs:**

```typescript
// Create Announcement Request
{
  type: 'system' | 'update' | 'reminder' | 'activity';
  title: string; // max 100 chars
  content: string; // max 500 chars, markdown
  targetGroup: {
    type: 'all' | 'age-group' | 'families';
    ageGroup?: '6-8' | '9-12';
    familyIds?: string[];
  };
  sendMethod: 'immediate' | 'scheduled';
  scheduledFor?: string; // ISO timestamp if scheduled
  isPublished: boolean; // false = draft, true = publish
}

// Create Announcement Response
{
  id: string;
  title: string;
  content: string;
  type: string;
  subtype: string;
  targetGroup: object;
  sendMethod: string;
  scheduledFor?: string;
  isPublished: boolean;
  createdAt: string;
  recipientsCount: number; // Number of parents notified
}

// Preview Response
{
  type: string;
  subtype: string;
  title: string;
  content: string;
  renderedMarkdown: string; // HTML preview
  sentBy: {
    id: string;
    name: string;
    avatarUrl?: string;
  };
  createdAt: string;
}
```

### Project Structure Notes

**Files to Create/Modify:**

```
database/schema/
â”œâ”€â”€ notifications.ts       # REVIEW: Verify schema supports announcements

lib/db/queries/
â”œâ”€â”€ notifications.ts        # EXTEND: Add announcement functions

lib/notifications/
â”œâ”€â”€ push.ts               # REVIEW: Verify supports system announcements

app/admin/announcements/
â”œâ”€â”€ page.tsx               # NEW: Announcement list
â”œâ”€â”€ create/
â”‚   â””â”€â”€ page.tsx           # NEW: Create form

components/forms/
â”œâ”€â”€ announcement-form.tsx   # NEW: Announcement creation/edit form

components/features/
â”œâ”€â”€ announcement-preview.tsx  # NEW: Markdown preview modal
â”œâ”€â”€ markdown-editor.tsx       # NEW: Simple markdown editor

tests/integration/
â”œâ”€â”€ announcements.spec.ts  # NEW: API tests

tests/e2e/
â”œâ”€â”€ announcements.spec.ts  # NEW: E2E tests
```

**Alignment with Unified Project Structure:**

- âœ… Schema in `database/schema/notifications.ts` (per architecture)
- âœ… Queries in `lib/db/queries/notifications.ts` (per-table file pattern)
- âœ… API routes in `app/api/admin/announcements/` (RESTful pattern)
- âœ… Components in `components/forms/` and `components/features/`
- âœ… No conflicts detected

### References

- **Architecture Decision:** ADR-5 (Function-based queries, NOT Repository pattern)
- **API Pattern:** [Source: docs/TECH_SPEC_API.md#REST-endpoints]
- **Component System:** [Source: docs/TECH_SPEC_ARCHITECTURE.md#component-boundaries]
- **Testing Standard:** [Source: docs/TECH_SPEC_BDD.md#Given-When-Then]
- **FR54:** [Source: _bmad-output/planning-artifacts/prd.md#FR54] ç®¡ç†å‘˜å¯ä»¥å‘å®¶é•¿å‘é€ç³»ç»Ÿé€šçŸ¥
- **Notification Center:** [Source: _bmad-output/planning-artifacts/epics.md#Story-6.7] Global Notification Center

### Critical Implementation Constraints

**ğŸ”´ RED LIST - MUST OBEY:**

1. **Database Operations:**
   - âœ… MUST use Drizzle ORM query builder
   - âŒ NEVER use raw SQL
   - âŒ NEVER write SQL in components/routes
   - âœ… All queries MUST be in `lib/db/queries/notifications.ts`

2. **Type Safety:**
   - âŒ NEVER use `any` type
   - âœ… MUST use `unknown` + type guards
   - âœ… NO `@ts-ignore` or `@ts-expect-error`

3. **Bun Runtime:**
   - âœ… MUST use `Bun.file()`, `Bun.write()` for file ops
   - âœ… MUST use `Bun.env` for environment variables
   - âŒ NEVER use Node.js APIs (`fs/promises`, `process.env`)

4. **BDD Testing:**
   - âœ… MUST write tests BEFORE implementation
   - âœ… MUST use Given-When-Then format
   - âœ… MUST use business language, NOT technical terms

5. **File Length:**
   - âœ… All files MUST be â‰¤ 800 lines
   - âœ… Split large components if needed

### UX/UI Requirements

**From UX Design Specification:**

- **Responsive Design:**
  - Admin PC layout: â‰¥1024px width
  - Large buttons for easy clicking
  - Clear visual hierarchy

- **Form Design:**
  - "ä¿å­˜ä¸ºè‰ç¨¿" and "å‘å¸ƒ" two-step workflow
  - Real-time validation feedback
  - Confirmation dialog before publishing
  - Markdown editor for content

- **Target Group Selector:**
  - "æ‰€æœ‰å®¶é•¿" (default)
  - Specific age group (6-8 / 9-12)
  - Specific family IDs (multi-select)

- **Send Method:**
  - Immediate: Push to all online devices immediately
  - Scheduled: Pick date/time for sending

- **Preview Modal:**
  - Render markdown content (bold, lists, links)
  - Show admin avatar and name
  - Display notification type badge (colored)
  - Show timestamp
  - "é¢„è§ˆ" button to open modal

- **Feedback:**
  - Success toast: "é€šçŸ¥å·²å‘é€åˆ°Xä¸ªå®¶é•¿"
  - Error toast with clear message
  - Loading states during send

### Testing Standards Summary

**BDD Format (Given-When-Then):**

```typescript
// Example: Create announcement as draft
it('given ç®¡ç†å‘˜å·²ç™»å½•ï¼Œwhen åˆ›å»ºè‰ç¨¿ç³»ç»Ÿå…¬å‘Šï¼Œthen å…¬å‘Šä¿å­˜ä¸ºè‰ç¨¿çŠ¶æ€', async () => {
  // Given: ç®¡ç†å‘˜å·²ç™»å½•
  const admin = await createAdmin();

  // When: åˆ›å»ºè‰ç¨¿ç³»ç»Ÿå…¬å‘Š
  const res = await request(app)
    .post('/api/admin/announcements')
    .set('Cookie', admin.session)
    .send({
      type: 'system',
      title: 'ç³»ç»Ÿæ›´æ–°é€šçŸ¥',
      content: '# ç³»ç»Ÿæ›´æ–°\\n\\næˆ‘ä»¬å°†äºæœ¬å‘¨è¿›è¡Œç³»ç»Ÿç»´æŠ¤...',
      targetGroup: { type: 'all' },
      sendMethod: 'immediate',
      isPublished: false // Draft
    });

  // Then: å…¬å‘Šä¿å­˜ä¸ºè‰ç¨¿çŠ¶æ€
  expect(res.status).toBe(201);
  expect(res.body.announcement.isPublished).toBe(false);
  expect(res.body.announcement.subtype).toBe('system');
});

// Example: Publish announcement
it('given è‰ç¨¿å…¬å‘Šå­˜åœ¨ï¼Œwhen ç®¡ç†å‘˜å‘å¸ƒå…¬å‘Šï¼Œthen å‘æ‰€æœ‰å®¶é•¿å‘é€é€šçŸ¥', async () => {
  // Given: è‰ç¨¿å…¬å‘Šå­˜åœ¨
  const draft = await createDraftAnnouncement();
  const parents = await getAllParents(); // Mock multiple parents

  // When: ç®¡ç†å‘˜å‘å¸ƒå…¬å‘Š
  const res = await request(app)
    .put(`/api/admin/announcements/${draft.id}`)
    .set('Cookie', admin.session)
    .send({ isPublished: true });

  // Then: å‘æ‰€æœ‰å®¶é•¿å‘é€é€šçŸ¥
  expect(res.status).toBe(200);
  expect(res.body.announcement.isPublished).toBe(true);
  expect(res.body.announcement.recipientsCount).toBe(parents.length);
  // Verify notifications created for all parents
  const notifications = await getNotificationsForParents(parents.map(p => p.id));
  expect(notifications).toHaveLength(parents.length);
});

// Example: Preview announcement
it('given è‰ç¨¿å…¬å‘Šå­˜åœ¨ï¼Œwhen ç®¡ç†å‘˜é¢„è§ˆå…¬å‘Šï¼Œthen æ˜¾ç¤ºMarkdownæ¸²æŸ“æ•ˆæœ', async () => {
  // Given: è‰ç¨¿å…¬å‘Šå­˜åœ¨
  const announcement = await createDraftAnnouncement();

  // When: ç®¡ç†å‘˜é¢„è§ˆå…¬å‘Š
  const res = await request(app)
    .get(`/api/admin/announcements/${announcement.id}/preview`)
    .set('Cookie', admin.session);

  // Then: æ˜¾ç¤ºMarkdownæ¸²æŸ“æ•ˆæœ
  expect(res.status).toBe(200);
  expect(res.body.preview).toContain('<h1>'); // Markdown bold
  expect(res.body.preview).toContain('<ul>'); // Markdown list
  expect(res.body.preview).toContain('<a>'); // Markdown link
});

// Example: Verify notification appears in parent's notification center
it('given ç³»ç»Ÿå…¬å‘Šå·²å‘é€ï¼Œwhen å®¶é•¿æŸ¥çœ‹é€šçŸ¥ä¸­å¿ƒï¼Œthen æ˜¾ç¤ºç³»ç»Ÿå…¬å‘Š', async () => {
  // Given: ç³»ç»Ÿå…¬å‘Šå·²å‘é€
  const parent = await createParent();
  await publishSystemAnnouncement(parent);

  // When: å®¶é•¿æŸ¥çœ‹é€šçŸ¥ä¸­å¿ƒ
  const res = await request(app)
    .get('/api/notifications')
    .set('Cookie', parent.session);

  // Then: æ˜¾ç¤ºç³»ç»Ÿå…¬å‘Š
  expect(res.status).toBe(200);
  const systemAnnouncement = res.body.notifications.find(n => n.subtype === 'system');
  expect(systemAnnouncement).toBeDefined();
  expect(systemAnnouncement.isRead).toBe(false);
});
```

**Test Coverage Requirements:**
- API endpoints: 100% coverage
- Query functions: 95%+ coverage
- E2E tests: Main workflows (create draft â†’ preview â†’ publish â†’ verify delivery)
- Performance tests: Verify API response time < 500ms

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
